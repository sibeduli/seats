{% extends 'base.html' %}

{% block title %}Pilih Tempat Duduk - YARSI Hippocratic Oath{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-xl p-4 sm:p-6 md:p-10 max-w-4xl w-full overflow-x-hidden">
    <!-- Header -->
    <div class="text-center mb-4 sm:mb-6">
        <h1 class="font-serif text-2xl sm:text-3xl md:text-4xl text-gray-800 mb-1">Pilih Tempat Duduk Anda</h1>
        <p class="text-gray-500 text-xs sm:text-sm md:text-base">BAIAT DOKTER MUSLIM - BATCH FEBRUARI 2026</p>
        <a href="/admin/availability" class="inline-flex items-center gap-1 mt-2 px-3 py-1.5 bg-amber-100 hover:bg-amber-200 text-amber-800 text-xs rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            Kelola Ketersediaan Kursi
        </a>
    </div>

    <!-- Venue Map -->
    <div class="mb-4 sm:mb-6">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded px-2 py-1">Peta
                Venue</span>
            <div class="flex items-center gap-2">
                <a href="/static/assets/image.png" target="_blank"
                    class="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs rounded transition-colors">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    Buka di Tab Baru
                </a>
                <button onclick="zoomMap(-0.3)"
                    class="p-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-600">âˆ’</button>
                <button onclick="zoomMap(0.3)"
                    class="p-1 bg-gray-100 hover:bg-gray-200 rounded text-gray-600">+</button>
                <button onclick="resetMap()"
                    class="p-1.5 bg-gray-100 hover:bg-gray-200 rounded text-gray-600 text-xs">Reset</button>
            </div>
        </div>
        <div id="venue-map-container"
            class="relative rounded-lg overflow-hidden border border-gray-200 bg-gray-50 h-64 cursor-grab active:cursor-grabbing">
            <img id="venue-map-img" src="/static/assets/image.png" alt="Venue Map" class="absolute select-none"
                style="transform-origin: 0 0;" draggable="false">
        </div>
    </div>

    <!-- Region Selector -->
    <div class="flex justify-center mb-4 sm:mb-6">
        <div class="inline-flex bg-gray-100 rounded-lg p-1 flex-wrap justify-center gap-0.5">
            <button onclick="showRegion('WLA')" id="btn-WLA"
                class="region-btn px-2.5 py-1.5 text-xs font-medium rounded-md transition-all bg-seat-available text-white">WLA</button>
            <button onclick="showRegion('WLB')" id="btn-WLB"
                class="region-btn px-2.5 py-1.5 text-xs font-medium rounded-md transition-all text-gray-600 hover:text-gray-800">WLB</button>
            <button onclick="showRegion('CL')" id="btn-CL"
                class="region-btn px-2.5 py-1.5 text-xs font-medium rounded-md transition-all text-gray-600 hover:text-gray-800">CL</button>
            <button onclick="showRegion('CR')" id="btn-CR"
                class="region-btn px-2.5 py-1.5 text-xs font-medium rounded-md transition-all text-gray-600 hover:text-gray-800">CR</button>
            <button onclick="showRegion('WRB')" id="btn-WRB"
                class="region-btn px-2.5 py-1.5 text-xs font-medium rounded-md transition-all text-gray-600 hover:text-gray-800">WRB</button>
            <button onclick="showRegion('WRA')" id="btn-WRA"
                class="region-btn px-2.5 py-1.5 text-xs font-medium rounded-md transition-all text-gray-600 hover:text-gray-800">WRA</button>
        </div>
    </div>

    <!-- Stage -->
    <div class="bg-gray-200 text-gray-600 text-center py-2 rounded mb-4 uppercase tracking-widest text-xs font-medium">
        Stage
    </div>
    <!-- Region Title -->
    <div class="text-center mb-4 flex flex-col sm:flex-row items-center justify-center gap-2">
        <span id="region-title" class="text-sm sm:text-lg font-medium text-gray-700">Region: WLA (Wing Left A)</span>
    </div>

    <!-- Seat Grids -->
    <div class="overflow-x-auto mb-6">
        <div id="seat-container" class="flex justify-center min-w-max">
            <!-- WLA: Stepped layout -->
            <div id="region-WLA" class="seat-region">
                <div class="flex flex-col gap-1 items-start" id="WLA-container"></div>
            </div>

            <!-- WLB: Stepped layout, seats 1-70 -->
            <div id="region-WLB" class="seat-region hidden">
                <div class="flex flex-col gap-1 items-start" id="WLB-container"></div>
            </div>

            <!-- CL: Stepped layout -->
            <div id="region-CL" class="seat-region hidden">
                <div class="flex flex-col gap-1 items-start" id="CL-container"></div>
            </div>

            <!-- CR: Stepped layout -->
            <div id="region-CR" class="seat-region hidden">
                <div class="flex flex-col gap-1 items-start" id="CR-container"></div>
            </div>

            <!-- WRB: Stepped layout -->
            <div id="region-WRB" class="seat-region hidden">
                <div class="flex flex-col gap-1 items-start" id="WRB-container"></div>
            </div>

            <!-- WRA: Stepped layout -->
            <div id="region-WRA" class="seat-region hidden">
                <div class="flex flex-col gap-1 items-start" id="WRA-container"></div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div
        class="flex flex-wrap justify-center items-center gap-3 sm:gap-4 md:gap-8 text-xs sm:text-sm text-gray-600 mb-4 sm:mb-6">
        <div class="flex items-center gap-1.5">
            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-seat-available rounded"></div>
            <span>Tersedia</span>
        </div>
        <div class="flex items-center gap-1.5">
            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-seat-selected rounded"></div>
            <span>Pilihan Anda</span>
        </div>
        <div class="flex items-center gap-1.5">
            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-seat-booked rounded"></div>
            <span>Sudah Dipesan</span>
        </div>
        <div class="flex items-center gap-1.5">
            <div class="w-3 h-3 sm:w-4 sm:h-4 bg-seat-available ring-2 ring-red-500 ring-inset rounded"></div>
            <span>Belum Tersedia (Admin Bisa Pesan)</span>
        </div>
    </div>

    <!-- Booking Form -->
    <div id="booking-section" class="border-t pt-4 sm:pt-6 hidden">
        <div class="text-center mb-3 sm:mb-4">
            <p class="text-sm sm:text-base text-gray-700">Kursi dipilih: <span id="selected-seats"
                    class="font-medium">-</span></p>
        </div>
        <div class="max-w-md mx-auto">
            <input type="text" id="guest-name" placeholder="Masukkan nama peserta..."
                class="w-full px-3 sm:px-4 py-2.5 sm:py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2 sm:mb-3">
            <input type="tel" id="guest-phone" placeholder="Masukkan nomor HP (contoh: 08123456789)"
                class="w-full px-3 sm:px-4 py-2.5 sm:py-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-3 sm:mb-4">
            <button onclick="bookSeats()"
                class="w-full bg-seat-available hover:bg-blue-600 text-white font-medium py-2.5 sm:py-3 text-sm sm:text-base rounded-lg transition-colors">
                Pesan Kursi
            </button>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
        <h2 class="font-serif text-2xl text-gray-800 mb-4 text-center">Konfirmasi Pemesanan</h2>

        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="mb-3">
                <p class="text-gray-500 text-sm">Nama Peserta</p>
                <p id="confirm-name" class="font-medium text-gray-800">-</p>
            </div>
            <div class="mb-3">
                <p class="text-gray-500 text-sm">Nomor HP</p>
                <p id="confirm-phone" class="font-medium text-gray-800">-</p>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Kursi Dipilih</p>
                <p id="confirm-seats" class="font-medium text-gray-800">-</p>
            </div>

            <!-- Mini-map Preview -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <p class="text-gray-500 text-sm mb-2">Preview Lokasi</p>
                <div id="seat-preview-map" class="bg-gray-100 rounded-lg p-3 overflow-x-auto">
                    <div class="flex justify-center gap-1 text-xs">
                        <!-- Mini regions will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="confirm-status" class="mb-4 hidden">
            <div class="flex items-center gap-2 text-yellow-600">
                <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span>Memeriksa ketersediaan kursi...</span>
            </div>
        </div>

        <div id="confirm-error" class="mb-4 hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">
                <span id="confirm-error-msg"></span>
            </div>
        </div>

        <div class="flex gap-3">
            <button onclick="cancelConfirmation()"
                class="flex-1 border border-gray-300 text-gray-700 font-medium py-3 rounded-lg hover:bg-gray-50 transition-colors">
                Batal
            </button>
            <button id="confirm-btn" onclick="confirmBooking()"
                class="flex-1 bg-seat-available hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-colors">
                Konfirmasi
            </button>
        </div>
    </div>
</div>

<!-- Success Modal with QR -->
<div id="success-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4 text-center">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
        </div>
        <h2 class="font-serif text-2xl text-gray-800 mb-2">Pemesanan Berhasil!</h2>
        <p class="text-gray-600 mb-4">Scan QR code untuk melihat tiket</p>

        <!-- QR Code -->
        <div id="ticket-qr" class="flex justify-center mb-4">
            <div class="bg-white p-4 rounded-lg shadow-inner"></div>
        </div>

        <a id="ticket-link" href="#" target="_blank"
            class="inline-block bg-seat-available hover:bg-blue-600 text-white font-medium px-6 py-3 rounded-lg transition-colors mb-2">
            Buka Halaman Tiket
        </a>
        <button onclick="closeSuccessModal()"
            class="block w-full text-gray-500 hover:text-gray-700 mt-2">Selesai</button>
    </div>
</div>

<script>
    // ============ MAP VIEWER ============
    // ADJUST THESE VALUES TO CHANGE INITIAL VIEW
    const INITIAL_MAP_SCALE = 1;  // 0.2 = 20%, 0.5 = 50%, 1 = 100%
    const INITIAL_MAP_X = 3;
    const INITIAL_MAP_Y = -266;

    let mapScale = INITIAL_MAP_SCALE;
    let mapX = INITIAL_MAP_X;
    let mapY = INITIAL_MAP_Y;
    let isDragging = false;
    let startX, startY;

    function initMap() {
        const container = document.getElementById('venue-map-container');

        updateMapTransform();

        container.onmousedown = (e) => { isDragging = true; startX = e.clientX - mapX; startY = e.clientY - mapY; };
        container.onmousemove = (e) => { if (isDragging) { mapX = e.clientX - startX; mapY = e.clientY - startY; updateMapTransform(); } };
        container.onmouseup = () => isDragging = false;
        container.onmouseleave = () => isDragging = false;

        container.ontouchstart = (e) => { isDragging = true; startX = e.touches[0].clientX - mapX; startY = e.touches[0].clientY - mapY; };
        container.ontouchmove = (e) => { if (isDragging) { e.preventDefault(); mapX = e.touches[0].clientX - startX; mapY = e.touches[0].clientY - startY; updateMapTransform(); } };
        container.ontouchend = () => isDragging = false;

        // Scroll wheel zoom toward cursor position
        container.onwheel = (e) => {
            e.preventDefault();
            const rect = container.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            zoomAtPoint(e.deltaY > 0 ? -0.1 : 0.1, mouseX, mouseY);
        };
    }

    function zoomAtPoint(delta, pointX, pointY) {
        const oldScale = mapScale;
        mapScale = Math.max(0.1, Math.min(3, mapScale + delta));
        
        // Adjust position so zoom centers on the point
        const scaleRatio = mapScale / oldScale;
        mapX = pointX - (pointX - mapX) * scaleRatio;
        mapY = pointY - (pointY - mapY) * scaleRatio;
        updateMapTransform();
    }

    function zoomMap(delta) {
        // Button zoom - zoom toward center of container
        const container = document.getElementById('venue-map-container');
        const centerX = container.offsetWidth / 2;
        const centerY = container.offsetHeight / 2;
        zoomAtPoint(delta, centerX, centerY);
    }

    function resetMap() {
        mapScale = INITIAL_MAP_SCALE;
        mapX = INITIAL_MAP_X;
        mapY = INITIAL_MAP_Y;
        updateMapTransform();
    }

    function updateMapTransform() {
        document.getElementById('venue-map-img').style.transform = `translate(${mapX}px, ${mapY}px) scale(${mapScale})`;
        console.log(`X: ${Math.round(mapX)}, Y: ${Math.round(mapY)}, Scale: ${mapScale.toFixed(2)}`);
    }

    document.addEventListener('DOMContentLoaded', initMap);
    // ============ END MAP VIEWER ============

    const regionConfig = {
        'WLA': { name: 'Wing Left A', type: 'stepped', seatsPerRow: [10, 10, 10, 10, 10, 10, 10, 10], leanDirection: 'left' },
        'WLB': { name: 'Wing Left B', type: 'stepped', seatsPerRow: [3, 5, 7, 8, 10, 12, 13, 15, 15], leanDirection: 'left' },
        'CL': { name: 'Center Left', type: 'stepped', seatsPerRow: [15, 15, 15, 15, 15, 16, 16, 15, 13, 11, 11, 9], leanDirection: 'right' },
        'CR': { name: 'Center Right', type: 'stepped', seatsPerRow: [15, 15, 15, 15, 15, 16, 16, 15, 13, 11, 11, 9], leanDirection: 'left' },
        'WRB': { name: 'Wing Right B', type: 'stepped', seatsPerRow: [3, 5, 7, 8, 10, 12, 13, 15, 15], leanDirection: 'right' },
        'WRA': { name: 'Wing Right A', type: 'stepped', seatsPerRow: [10, 10, 10, 10, 10, 10, 10, 10], leanDirection: 'right' }
    };

    function createSeat(region, num) {
        const seat = document.createElement('button');
        seat.className = 'w-8 h-8 text-xs font-medium rounded bg-seat-available text-white transition-colors select-none';
        seat.textContent = num;
        seat.dataset.seat = `${region}-${num}`;
        seat.dataset.region = region;
        seat.dataset.number = num;
        seat.onclick = () => toggleSeat(seat);
        return seat;
    }

    function createSeatWithRow(region, row, num) {
        const seat = document.createElement('button');
        seat.className = 'w-8 h-8 text-xs font-medium rounded bg-seat-available text-white transition-colors select-none';
        seat.textContent = num;
        seat.dataset.seat = `${region}-${row}${num}`;
        seat.onclick = () => toggleSeat(seat);
        return seat;
    }

    let bookedSeats = [];
    let availability = { regions: {}, seats: {} };

    function toggleSeat(seat) {
        if (seat.classList.contains('bg-seat-booked')) return;
        if (seat.classList.contains('bg-seat-selected')) {
            seat.classList.remove('bg-seat-selected');
            seat.classList.add('bg-seat-available');
        } else {
            seat.classList.remove('bg-seat-available');
            seat.classList.add('bg-seat-selected');
        }
        updateBookingSection();
    }

    function updateBookingSection() {
        const selected = document.querySelectorAll('[data-seat].bg-seat-selected');
        const section = document.getElementById('booking-section');
        const display = document.getElementById('selected-seats');

        if (selected.length > 0) {
            section.classList.remove('hidden');
            const seatNames = Array.from(selected).map(s => s.dataset.seat);
            display.textContent = seatNames.join(', ');
        } else {
            section.classList.add('hidden');
            display.textContent = '-';
        }
    }

    function getSelectedSeats() {
        const selected = document.querySelectorAll('[data-seat].bg-seat-selected');
        return Array.from(selected).map(s => {
            const [region, num] = s.dataset.seat.split('-');
            return { region, number: parseInt(num) };
        });
    }

    let pendingBooking = { name: '', seats: [] };

    function bookSeats() {
        const name = document.getElementById('guest-name').value.trim();
        const phone = document.getElementById('guest-phone').value.trim();
        const seats = getSelectedSeats();

        if (!name) {
            alert('Mohon masukkan nama peserta');
            return;
        }
        if (!phone) {
            alert('Mohon masukkan nomor HP');
            return;
        }
        if (seats.length === 0) {
            alert('Mohon pilih kursi terlebih dahulu');
            return;
        }

        // Store pending booking and show confirmation
        pendingBooking = { name, phone, seats };
        document.getElementById('confirm-name').textContent = name;
        document.getElementById('confirm-phone').textContent = phone;
        document.getElementById('confirm-seats').textContent = seats.map(s => `${s.region}-${s.number}`).join(', ');
        document.getElementById('confirm-error').classList.add('hidden');
        document.getElementById('confirm-status').classList.add('hidden');
        document.getElementById('confirm-btn').disabled = false;

        // Render mini-map preview
        renderSeatPreview(seats);

        document.getElementById('confirm-modal').classList.remove('hidden');
    }

    function renderSeatPreview(seats) {
        const previewMap = document.getElementById('seat-preview-map');
        const regionOrder = ['WLA', 'WLB', 'CL', 'CR', 'WRB', 'WRA'];

        // Group seats by region
        const seatsByRegion = {};
        seats.forEach(s => {
            if (!seatsByRegion[s.region]) seatsByRegion[s.region] = [];
            seatsByRegion[s.region].push(s.number);
        });

        // Build mini-map HTML
        let html = '<div class="flex flex-col items-center gap-2">';
        html += '<div class="text-gray-500 text-xs mb-1">ðŸŽ­ PANGGUNG</div>';
        html += '<div class="flex gap-2 flex-wrap justify-center">';

        regionOrder.forEach(region => {
            const isSelected = seatsByRegion[region] && seatsByRegion[region].length > 0;
            const bgColor = isSelected ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500';
            const seatNums = isSelected ? seatsByRegion[region].sort((a, b) => a - b).join(', ') : '';

            html += `<div class="flex flex-col items-center">`;
            html += `<div class="w-10 h-8 ${bgColor} rounded text-xs flex items-center justify-center font-medium">${region}</div>`;
            if (isSelected) {
                html += `<div class="text-xs text-green-700 mt-1 max-w-16 text-center truncate" title="${seatNums}">${seatNums}</div>`;
            }
            html += `</div>`;
        });

        html += '</div></div>';
        previewMap.innerHTML = html;
    }

    function cancelConfirmation() {
        document.getElementById('confirm-modal').classList.add('hidden');
        pendingBooking = { name: '', seats: [] };
    }

    async function confirmBooking() {
        const { name, phone, seats } = pendingBooking;
        const confirmBtn = document.getElementById('confirm-btn');
        const statusEl = document.getElementById('confirm-status');
        const errorEl = document.getElementById('confirm-error');
        const errorMsg = document.getElementById('confirm-error-msg');

        // Show loading
        confirmBtn.disabled = true;
        statusEl.classList.remove('hidden');
        errorEl.classList.add('hidden');

        try {
            // Check availability first (race condition check)
            const checkRes = await fetch('/api/check-seats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seats })
            });
            const checkData = await checkRes.json();

            if (!checkData.available) {
                statusEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                errorMsg.textContent = checkData.error || 'Beberapa kursi sudah dipesan oleh orang lain. Silahkan pilih kursi lain.';
                confirmBtn.disabled = false;
                return;
            }

            // Proceed with booking
            const res = await fetch('/api/book', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, phone, seats })
            });
            const data = await res.json();

            statusEl.classList.add('hidden');

            if (data.success) {
                document.getElementById('confirm-modal').classList.add('hidden');

                // Show success with QR
                const ticketUrl = window.location.origin + data.ticket_url;
                document.getElementById('ticket-link').href = data.ticket_url;

                // Generate QR code
                const qrContainer = document.getElementById('ticket-qr');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: ticketUrl,
                    width: 180,
                    height: 180,
                    colorDark: '#1a3a3a',
                    colorLight: '#ffffff'
                });

                document.getElementById('success-modal').classList.remove('hidden');
            } else {
                errorEl.classList.remove('hidden');
                errorMsg.textContent = data.error || 'Gagal memesan kursi';
                confirmBtn.disabled = false;
            }
        } catch (err) {
            statusEl.classList.add('hidden');
            errorEl.classList.remove('hidden');
            errorMsg.textContent = 'Terjadi kesalahan: ' + err;
            confirmBtn.disabled = false;
        }
    }

    function closeSuccessModal() {
        document.getElementById('success-modal').classList.add('hidden');
        location.reload();
    }

    async function loadBookedSeats() {
        try {
            const res = await fetch('/api/seats');
            bookedSeats = await res.json();
            markBookedSeats();
        } catch (err) {
            console.error('Failed to load booked seats:', err);
        }
    }

    function markBookedSeats() {
        bookedSeats.forEach(seat => {
            const el = document.querySelector(`[data-seat="${seat.region}-${seat.number}"]`);
            if (el) {
                el.classList.remove('bg-seat-available', 'hover:bg-blue-600');
                el.classList.add('bg-seat-booked', 'cursor-not-allowed');
            }
        });
    }

    function initSteppedRegion(region) {
        const container = document.getElementById(`${region}-container`);
        if (!container) return;

        const config = regionConfig[region];
        const leanDirection = config.leanDirection || 'left';
        let seatNum = 1;

        // Set container alignment based on lean direction
        container.className = 'flex flex-col gap-1';
        if (leanDirection === 'left') {
            container.classList.add('items-start');
        } else if (leanDirection === 'right') {
            container.classList.add('items-end');
        } else {
            container.classList.add('items-center');
        }

        config.seatsPerRow.forEach((seatsInRow, rowIndex) => {
            const rowDiv = document.createElement('div');
            // Always use flex-row-reverse so numbering is right to left
            rowDiv.className = 'flex gap-1 flex-row-reverse';

            for (let i = 0; i < seatsInRow; i++) {
                rowDiv.appendChild(createSeat(region, seatNum));
                seatNum++;
            }
            container.appendChild(rowDiv);
        });
    }

    function initSeats() {
        for (const [region, config] of Object.entries(regionConfig)) {
            if (config.type === 'stepped') {
                initSteppedRegion(region);
            } else if (config.rows) {
                config.rows.forEach(row => {
                    const rowContainer = document.getElementById(`${region}-${row}`);
                    if (rowContainer) {
                        for (let i = 1; i <= config.seats; i++) {
                            rowContainer.appendChild(createSeatWithRow(region, row, i));
                        }
                    }
                });
            }
        }
    }

    function showRegion(region) {
        document.querySelectorAll('.seat-region').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.region-btn').forEach(btn => {
            btn.classList.remove('bg-seat-available', 'text-white');
            btn.classList.add('text-gray-600');
        });

        document.getElementById(`region-${region}`).classList.remove('hidden');
        document.getElementById(`btn-${region}`).classList.add('bg-seat-available', 'text-white');
        document.getElementById(`btn-${region}`).classList.remove('text-gray-600');
        document.getElementById('region-title').textContent = `Region: ${region} (${regionConfig[region].name})`;
    }

    function isSeatAvailable(region, seatNum) {
        const regionAvailable = availability.regions[region] || false;
        const seatAvailability = availability.seats[region] || {};
        if (seatAvailability[seatNum] !== undefined) {
            return seatAvailability[seatNum];
        }
        return regionAvailable;
    }

    function updateSeatAvailability() {
        document.querySelectorAll('[data-seat]').forEach(seat => {
            const region = seat.dataset.region;
            const seatNum = seat.dataset.number;
            
            if (seat.classList.contains('bg-seat-booked')) return;
            if (seat.classList.contains('bg-seat-selected')) return;
            
            const isAvailable = isSeatAvailable(region, seatNum);
            
            // Admin can still click unavailable seats, but show visual indicator
            if (!isAvailable) {
                seat.classList.add('ring-2', 'ring-red-500', 'ring-inset');
            } else {
                seat.classList.remove('ring-2', 'ring-red-500', 'ring-inset');
            }
        });
        
        updateRegionButtons();
    }

    function updateRegionButtons() {
        Object.keys(regionConfig).forEach(region => {
            const btn = document.getElementById(`btn-${region}`);
            const isAvailable = availability.regions[region] || false;
            
            let indicator = btn.querySelector('.availability-indicator');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'availability-indicator block text-[10px] font-normal';
                btn.appendChild(indicator);
            }
            
            if (!isAvailable) {
                indicator.textContent = 'Belum Tersedia';
                indicator.classList.add('text-red-300');
            } else {
                indicator.textContent = '';
            }
        });
    }

    async function loadAvailability() {
        try {
            const res = await fetch('/api/availability');
            availability = await res.json();
            updateSeatAvailability();
        } catch (err) {
            console.error('Failed to load availability:', err);
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        initSeats();
        await loadBookedSeats();
        await loadAvailability();
    });
</script>
{% endblock %}